---
- name: Deploy RKE2 Cluster
  hosts: all
  become: yes
  vars:
    rke2_config_dir: "/etc/rancher/rke2"
    rke2_token_file: "/var/lib/rancher/rke2/server/node-token"
    rke2_token_local: "./rke2_token"
    kubectl_version: "v1.29.6"
    crictl_version: "v1.34.0"

  tasks:
    - name: Update and upgrade packages
      apt:
        update_cache: yes
        upgrade: dist
      when: ansible_facts['pkg_mgr'] == 'apt'

    - name: Disable swap
      command: swapoff -a
      become: yes

    - name: Remove swap entry from /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*swap.*)$'
        replace: '# \1'

    ####################################################################
    # INSTALL KUBECTL
    ####################################################################
    - name: Check if kubectl is installed
      stat:
        path: /usr/local/bin/kubectl
      register: kubectl_stat

    - name: Download kubectl if not installed
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'
      when: not kubectl_stat.stat.exists

    - name: Ensure kubectl is executable
      file:
        path: /usr/local/bin/kubectl
        mode: '0755'

    ####################################################################
    # RKE2 INSTALLATION CHECK
    ####################################################################
    - name: Check if RKE2 server is installed
      stat:
        path: /usr/local/bin/rke2
      register: rke2_stat

    ####################################################################
    # INSTALL RKE2 BASED ON ROLE
    ####################################################################
    - name: Install RKE2 server
      shell: |
        curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="server" sh -
        systemctl enable rke2-agent.service
      when: "'server-only' in hostvars[inventory_hostname].role and not rke2_stat.stat.exists"

    - name: Wait for RKE2 token to exist
      stat:
        path: "{{ rke2_token_file }}"
      register: token_stat
      until: token_stat.stat.exists
      retries: 30
      delay: 10
      when: "'server-only' in hostvars[inventory_hostname].role"

    - name: Fetch RKE2 token from first server
      fetch:
        src: "{{ rke2_token_file }}"
        dest: "{{ rke2_token_local }}"
        flat: yes
      when: inventory_hostname == groups['servers'][0]

    ####################################################################
    # SERVER-WORKER NODES
    ####################################################################
    - name: Install RKE2 server on server-worker nodes if not installed
      shell: |
        curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="server" sh -
        systemctl enable rke2-server.service
      when: hostvars[inventory_hostname].role == "server-worker" and not rke2_stat.stat.exists

    ####################################################################
    # WORKER NODES
    ####################################################################
    - name: Install RKE2 agent on worker nodes if not installed
      shell: |
        curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="agent" sh -
        systemctl enable rke2-agent.service
      when: hostvars[inventory_hostname].role == "worker" and not rke2_stat.stat.exists

    ####################################################################
    # CONFIGURATION FILES
    ####################################################################
    - name: Ensure RKE2 config directory exists
      file:
        path: "{{ rke2_config_dir }}"
        state: directory
        mode: '0755'

    - name: Generate RKE2 config from template
      template:
        src: templates/rke2-config.yaml.j2
        dest: "{{ rke2_config_dir }}/config.yaml"
        owner: root
        group: root
        mode: '0644'
      vars:
        role: "{{ hostvars[inventory_hostname].role }}"

    - name: Start RKE2 server
      shell: |
        systemctl start rke2-server.service
      when: "'server' in hostvars[inventory_hostname].role"

    - name: Start RKE2 agent on worker nodes
      shell: |
        systemctl start rke2-agent.service
      when: 'hostvars[inventory_hostname].role == "worker" and rke2_stat.stat.exists'
